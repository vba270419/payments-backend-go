# Payments Backend

A GO implementation of a simple payments service which supports the following operations:
- fetch a payment resource
- create, update and delete a payment resource
- list a collection of payment resources
- persist resource state

Please refer to _API_Documentation.pdf_ to learn more about the payment API design.

## Running an application

1) The current implementation uses MongoDB for persisting payment resources, therefore the pre-requisite to run an application is to have a running instance of a MongoDB. For example, it can be a local MongoDB docker process:
    ```
    docker run -d -p 27017:27017 --name payments_mongodb mongo
    ```  
2) Build an application using the simple go command: 
    ```
    go build -o payments-server
    ```
3) To run an application with default parameters you can simply start the application built in the previous step:
    ```
    ./payments-server
    ```    
    or, you can pass custom MongoDB connection properties as well as some other configurable properties to an application using _--conf_ flag. As an argument, a path to a json configuration file has to be provided. 
   ```
    ./payments-server --conf=<path_to_json_file>
   ``` 
   If _--conf_ flag is not set, application by default reads _config/server.json_ file. The full list of supported properties is described in the **Implementation details** section 

## Test running application
For running manual tests you need to provide a payment payload. For that purpose, you can make a copy of _test_resources/single_payment.json_ file.

1) Payment creation can be tested using the following command
    ```
    curl -v -d "@path_to_your_payment.json"  http://127.0.0.1:8000/v1/payments/create
    ```
    The output should look similar to one below, and the response header must contain the location link to a created resource.
    ```
    > POST /v1/payments/create HTTP/1.1
    > Host: 127.0.0.1:8000
    > User-Agent: curl/7.58.0
    > Accept: */*
    > Content-Length: 1803
    > Content-Type: application/x-www-form-urlencoded
    > Expect: 100-continue
    > 
    < HTTP/1.1 100 Continue
    * We are completely uploaded and fine
    < HTTP/1.1 201 Created
    < Content-Type: application/json; charset=UTF-8
    < Location: http://127.0.0.1:8000/v1/payments/get/13b84dab-6f25-11e9-b56b-48ba4e4dd1fe
    < Date: Sun, 05 May 2019 11:01:04 GMT
    < Content-Length: 0

    ```
2) Fetch created payment resource
    ```
    curl -v http://127.0.0.1:8000/v1/payments/get/13b84dab-6f25-11e9-b56b-48ba4e4dd1fe
    ```
    
    The response's body should contain the payment object 
3) Fetch all payment resources
    ```
    curl -v http://127.0.0.1:8000/v1/payments/all
    ```
4) Update the payment resource

   Update your payment.json by changing the **id** property to the id generated by a server (for example "id": "13b84dab-6f25-11e9-b56b-48ba4e4dd1fe"). Do **not** modify version number.
   ```
    curl -v -d "@path_to_your_payment.json"-X PUT http://127.0.0.1:8000/v1/payments/update
   ```
   The output should look similar to one below, and the response header must contain the location link to an updated resource. Note that the updated resource now has a version set to 2.
   ```
    > PUT /v1/payments/update HTTP/1.1
    > Host: 127.0.0.1:8000
    > User-Agent: curl/7.58.0
    > Accept: */*
    > Content-Length: 1806
    > Content-Type: application/x-www-form-urlencoded
    > Expect: 100-continue
    > 
    < HTTP/1.1 100 Continue
    * We are completely uploaded and fine
    < HTTP/1.1 200 OK
    < Content-Type: application/json; charset=UTF-8
    < Location: http://127.0.0.1:8000/v1/payments/get/13b84dab-6f25-11e9-b56b-48ba4e4dd1fe
    < Date: Sun, 05 May 2019 11:18:47 GMT
    < Content-Length: 0
   ```
5) Delete the payment resource
    ```
    curl -v -X DELETE http://127.0.0.1:8000/v1/payments/delete/13b84dab-6f25-11e9-b56b-48ba4e4dd1fe
    ```
    The output should look similar to one below, after the deleting payment resource the get method should return 404 code as a response.
    ```
    > GET /v1/payments/get/13b84dab-6f25-11e9-b56b-48ba4e4dd1fe HTTP/1.1
    > Host: 127.0.0.1:8000
    > User-Agent: curl/7.58.0
    > Accept: */*
    > 
    < HTTP/1.1 404 Not Found
    < Content-Type: application/json; charset=UTF-8
    < Date: Sun, 05 May 2019 11:28:31 GMT
    < Content-Length: 0
    ```    

## Implementation details

1) In order to run an application the following properties must be configured:

    | Property          | Description                   | Default value |
    | --------          | -----------                   | ------ |
    |**server_host**    |server TCP address to listen on|127.0.0.1|
    |**server_port**    |server port number             |8000|  
    |**server_timeout** |the maximum duration for reading and writing requests before http server times out (in seconds)|15|
    |**mongodb_host**   |MongoDB instance host address|127.0.0.1|
    |**mongodb_port**   |MongoDB instance port number|27017|  
    |**mongodb_timeout**|the maximum duration for querying and persisting payment resources before MongoDB session times out (in seconds)|10|
    The application reads them from a json configuration file, if a custom configuration file is not provided application will read _config/server.json_ by default.
2) The application uses payment's **version** property to detect the conflicts while updating the payment, i.e. if the payment version does not match the version in the database, the application should return 409 code.
3) In order to implement different storage, the **PaymentRepository** interface must be implemented accordingly.       



## Out of the scope
Current implementation does **not** not support:
- user authentication and authorization
- secure MongoDB connection
- pagination and filtering in get all payment resources
- BDD 